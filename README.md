# 高性能聊天室

这是一个基于Go语言的高性能聊天室应用，使用Kafka作为消息队列和Redis作为缓存系统，支持超高并发WebSocket连接和分布式部署。

## 系统架构

系统采用以下技术栈：

- **后端框架**：Gin
- **数据库**：MySQL
- **消息队列**：Kafka
- **缓存系统**：Redis
- **WebSocket**：gorilla/websocket
- **认证**：JWT

## 性能优化

相比原始版本，本项目进行了以下优化：

1. **Kafka消息队列**：使用Kafka替代Go Channel，实现真正的分布式消息处理，支持水平扩展和超高并发
2. **连接池优化**：
   - 数据库连接池配置
   - Redis连接池配置
   - WebSocket连接管理优化
3. **多级缓存**：
   - 用户信息缓存
   - 群组信息缓存
   - 最近消息缓存
4. **限流保护**：
   - API请求限流
   - WebSocket连接限流
5. **异步处理**：
   - 消息异步保存
   - 状态异步更新
6. **优雅关闭**：支持服务器优雅关闭，确保消息不丢失

## 部署要求

- Go 1.16+
- MySQL 5.7+
- Redis 6.0+
- Kafka 2.8+
- ZooKeeper 3.6+

## 配置说明

复制`.env.example`文件为`.env`，并根据实际情况修改配置：

```bash
cp .env.example .env
```

主要配置项说明：

- `MAX_CONNECTIONS`：最大WebSocket连接数
- `REDIS_POOL_SIZE`：Redis连接池大小
- `DB_MAX_IDLE_CONNS`和`DB_MAX_OPEN_CONNS`：数据库连接池配置
- `CACHE_EXPIRATION`：缓存过期时间（秒）

## 启动服务

```bash
go run main.go
```

## 水平扩展

本系统支持水平扩展，可以通过以下方式部署多个实例：

1. 多个应用实例共享同一个Redis服务
2. 使用负载均衡器（如Nginx）分发请求
3. 会话状态通过Redis共享

## 性能测试

在分布式部署下，系统可以支持：

- 100,000+ 并发WebSocket连接
- 每秒10,000+ 消息处理能力
- 毫秒级消息延迟

## 监控与维护

系统提供了以下监控端点：

- `/api/monitor/system`：查看系统状态，包括内存使用、协程数量、Kafka指标等
- `/api/monitor/connections`：查看当前WebSocket连接数

## 项目难点与重点

### 1. 高并发消息处理

- **难点**：在高并发场景下，如何保证消息的可靠传递和低延迟
- **解决方案**：
  - 使用Kafka作为消息队列，支持水平扩展和高吞吐量
  - 消息分区和消费者组实现负载均衡
  - 同步/异步发送策略：重要消息同步发送确保可靠性，非关键消息异步发送提高性能

### 2. 分布式架构设计

- **难点**：如何设计支持水平扩展的分布式聊天系统
- **解决方案**：
  - 无状态服务设计，便于部署多实例
  - 使用Redis共享会话状态和在线用户信息
  - Kafka消费者组自动负载均衡
  - 主题分区策略优化：按用户ID和群组ID分区，确保消息顺序性

### 3. 实时性与可靠性平衡

- **难点**：如何在保证消息实时性的同时确保可靠性
- **解决方案**：
  - WebSocket长连接保证实时通信
  - 消息持久化到数据库和Kafka
  - 消息确认机制和重试策略
  - 优雅关闭确保消息不丢失

### 4. 性能优化

- **难点**：如何优化系统性能，支持大量并发连接
- **解决方案**：
  - 连接池优化（数据库、Redis）
  - 消息压缩和批处理
  - 多级缓存策略
  - 异步处理非关键操作
  - 限流保护机制

### 5. 监控与可观测性

- **难点**：如何实时监控系统状态，快速定位问题
- **解决方案**：
  - 系统指标收集（内存、协程数等）
  - Kafka消息指标监控
  - 连接数监控
  - 错误日志和异常处理
